name: Hourly AQI Prediction

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  run_inference:
    runs-on: ubuntu-latest
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      MONGODB_FEATURE_DB: ${{ secrets.MONGODB_FEATURE_DB }}
      MONGODB_FEATURE_COLLECTION: ${{ secrets.MONGODB_FEATURE_COLLECTION }}
      MONGODB_PREDICTION_DB: ${{ secrets.MONGODB_PREDICTION_DB }}
      MONGODB_PREDICTION_COLLECTION: ${{ secrets.MONGODB_PREDICTION_COLLECTION }}
      DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
      DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dagshub mlflow pymongo python-dotenv certifi

      # Move diagnostic BEFORE the main script
      - name: Diagnose MongoDB connectivity
        run: |
          python - <<'PY'
          import ssl, sys, traceback, os
          import pymongo, certifi
          
          print("=" * 60)
          print("OpenSSL version:", ssl.OPENSSL_VERSION)
          print("Certifi CA bundle:", certifi.where())
          print("=" * 60)
          
          uri = os.environ.get("MONGODB_URI")
          if not uri:
              print("ERROR: MONGODB_URI not set")
              sys.exit(1)
          
          print("URI present: ✓")
          print("Attempting connection...")
          
          try:
              client = pymongo.MongoClient(
                  uri,
                  tls=True,
                  tlsCAFile=certifi.where(),
                  serverSelectionTimeoutMS=20000,
                  connectTimeoutMS=20000
              )
              info = client.server_info()
              print("✓ Connected successfully!")
              print(f"MongoDB version: {info.get('version')}")
          except Exception as e:
              print(f"✗ Connection failed: {type(e).__name__}")
              print(f"Error: {e}")
              traceback.print_exc()
              sys.exit(1)
          PY

      - name: Run Multi-Day Prediction
        run: |
          python -m src.inference.predict_multi_day