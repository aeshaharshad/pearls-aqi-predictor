name: Hourly AQI Prediction

on:
  schedule:
    - cron: "0 * * * *"  # Every hour
  workflow_dispatch:      # Manual trigger

concurrency:
  group: hourly-aqi
  cancel-in-progress: true

jobs:
  run_inference:
    runs-on: ubuntu-latest
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      MONGODB_FEATURE_DB: ${{ secrets.MONGODB_FEATURE_DB }}
      MONGODB_FEATURE_COLLECTION: ${{ secrets.MONGODB_FEATURE_COLLECTION }}
      MONGODB_PREDICTION_DB: ${{ secrets.MONGODB_PREDICTION_DB }}
      MONGODB_PREDICTION_COLLECTION: ${{ secrets.MONGODB_PREDICTION_COLLECTION }}
      DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
      DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python 3.10.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install 'pymongo[srv]>=4.5.0' certifi dagshub mlflow python-dotenv

      - name: Verify MongoDB Connection
        run: |
          python - <<'PY'
          import ssl, sys, os
          import pymongo
          
          print("=" * 60)
          print("ðŸ” Environment Check")
          print("=" * 60)
          print(f"Python: {sys.version}")
          print(f"OpenSSL: {ssl.OPENSSL_VERSION}")
          print(f"PyMongo: {pymongo.__version__}")
          print("=" * 60)
          
          uri = os.environ.get("MONGODB_URI")
          if not uri:
              print("âŒ MONGODB_URI not set")
              sys.exit(1)
          
          print("âœ… MONGODB_URI present")
          print("ðŸ”— Testing connection with ssl.CERT_NONE...")
          
          try:
              client = pymongo.MongoClient(
                  uri,
                  tls=True,
                  tlsInsecure=True,
                  serverSelectionTimeoutMS=30000,
                  connectTimeoutMS=30000
              )
              info = client.server_info()
              print(f"âœ… Connected to MongoDB v{info.get('version')}")
              print("=" * 60)
          except Exception as e:
              print(f"âŒ Connection failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PY

      - name: Run Multi-Day Prediction
        run: |
          python -m src.inference.predict_multi_day